h2. Launch the Chef Server + Hadoop Master node

* _If you already have a chef server, this isn't for you. See instructions in pt?something_
* _If you're using the west coast availability zone, first run @export EC2_URL=https://us-west-1.ec2.amazonaws.com@ to work around a bug in the right_aws gem_

To kick off the chef+master node, go to the cluster_chef directory and run:

<pre><code>
  $ cd ~/path/to/cluster_chef
  $ cloud start -n chefmaster -c clouds/zaius_clouds.rb
</code></pre>

You can check the "AWS console":http://bit.ly/awsconsole for progress towards startup. If there are problems, see "Tips and Trobleshooting.":http://github.com/infochimps/cluster_chef/blob/master/notes/pt9-tips-and-troubleshooting.textile

h3. After startup

Log in to the chef server and retrieve a few settings and credentials you'll need.

<pre><code>
  $ cloud ssh -n master -c clouds/zaius_clouds.rb
</code></pre>

* Find the webui's initial password with @sudo cat /etc/chef/server.rb | grep -i pass@.
* Use it to log in to the chef webui: http://chef.YOURDOMAIN.COM:4040
* Set the webui's admin password to something you chose.

h3. Set up knife and webui

On the server, set up knife:

<pre><code>
  sudo knife configure -i
  Your chef server URL? http://chef.YOURDOMAIN.com:4000
  Your client user name? knife_user
  Your validation client user name? chef-validator
  Path to a chef repository (or leave blank)? 
  WARN: Creating initial API user...
</code></pre>  

* Copy the chef credentials over: copy @~/.chef/knife_user.pem@ and @/etc/chef/validation.pem@ on the server
to @~/.hadoop-ec2/keypairs/knife_user.pem@ and
@~/.hadoop-ec2/keypairs/chef-validator.pem@ on your computer.
* Fix their permissions: @chmod og-rwx ~/.hadoop-ec2/keypairs/*.pem@
* Copy the ~/path/to/cluster_chef/config/knife.rb to ~/.chef/knife.rb. Check whether any settings in that file need tuning.

If everything went right, @knife client list@ should show something like

<pre><code>
  [
    "chef-validator", 
    "chef-webui",
    "knife_user"
  ]
</code></pre>

h2. Importing cookbooks, roles and databags to the server:

<pre><code>
  cd ~/path/to/cluster_chef
  for foo in roles/*.rb ; do echo $foo ; knife role from file $foo ; done
  knife cookbook upload --all
  rake load_data_bags
  rake load_data_bags
</code></pre>
(_run the rake load_data_bags task twice: once to create, again to populate each data bag_)

* Run chef-client to have chef configure itself.



h2. Next Steps

Next, follow the instructions for "Step 3: Hadoop Master.":http://github.com/infochimps/cluster_chef/blob/master/notes/pt3-create-hadoop-master.textile
