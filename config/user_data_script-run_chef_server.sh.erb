#!/usr/bin/env bash
progresslog='/tmp/user_data-progress.log'
mkdir -p /tmp ; chmod a+rwx /tmp

# A url directory with the scripts you'd like to stuff into the machine
REMOTE_FILE_URL_BASE="<%= bootstrap_scripts_url_base %>"

# unscrewup the hostname every way I can think of. Rabbitmq is a real buttmunch
# about the hostname -- it will hang forever on bootstrap if `hostname -s`
# doesn't resolve back to this host. One of the following fixes this, not sure which.
export HOSTNAME=<%= hostname %> PUBLIC_IP=<%= public_ip %>                 
bash     -c "echo '$HOSTNAME' > /etc/hostname" ;
hostname -F /etc/hostname ;
sysctl   -w kernel.hostname=$HOSTNAME ;
# Your /etc/hosts needs to end up looking like this (order is important):
# 127.0.0.1      chef.YOURDOMAIN.COM chef localhost 
# XXX.XXX.XX.XX  chef.YOURDOMAIN.COM chef
sed -i "s/127.0.0.1 *localhost/127.0.0.1      $HOSTNAME `hostname -s` localhost/" /etc/hosts
if grep -q $PUBLIC_IP /etc/hosts  ; then true ; else bash -c "echo '$PUBLIC_IP $HOSTNAME `hostname -s `' >> /etc/hosts" ; fi

echo "`date` Pulling in chef client and server scripts"  >> $progresslog 
cp /etc/chef/client.rb /etc/chef/client-orig.rb ;
wget -nv ${REMOTE_FILE_URL_BASE}/client.rb -O /etc/chef/client.rb ;
cat > /etc/chef/client-config.json <<EOF
<%= chef_config[:attributes].to_json %>
EOF
sed -i 's/chef_server_url.*/chef_server_url    "http://<%= hostname %>:4000"/' /etc/chef/server.rb

echo "`date` Making rabbit be friends with chef"  >> $progresslog
sudo service rabbitmq-server stop
sudo rm /var/log/rabbitmq/* /var/lib/rabbitmq/mnesia/rabbit/*
sudo service rabbitmq-server start
sudo rabbitmqctl add_vhost /chef
sudo rabbitmqctl add_user chef testing
sudo rabbitmqctl set_permissions -p /chef chef ".*" ".*" ".*"

echo "`date` restarting chef infrastructure"  >> $progresslog 
for foo in couchdb chef-{server,solr,solr-indexer,server-webui} ; do
  sudo service $foo restart 
  sleep 2 
done

echo "`date` running chef client, check /etc/sv/chef-client/log/main/current"  >> $progresslog 
service chef-client restart
sudo update-rc.d chef-client defaults

cat >> $progresslog <<EOF
Next Steps:
* sudo knife configure -i
* copy /etc/chef/validation.pem     from here to ~/.hadoop-ec2/keypairs/chef-validator.pem on your local computer
* copy ~ubuntu/.chef/knife_user.pem from here to ~/.hadoop-ec2/keypairs/knife_user.pem     on your local computer

On your computer:
* chmod og -rwx ~/.hadoop-ec2/keypairs/*.pem
* knife node list

Enjoy!
EOF

echo "`date` User data script (chef server bootstrap) complete: `date`"  >> $progresslog 
