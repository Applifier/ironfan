#!/bin/sh
export JAVA_HOME=/usr/lib/jvm/java-6-sun/jre CASSANDRA_CONF=/etc/cassandra/storage-conf.xml CASSANDRA_HOME=/usr/local/share/cassandra

cassandra_home=<%= node[:cassandra][:cassandra_home] %>
cassandra_bin=${cassandra_home}/build/classes
CASSANDRA_CONF=<%= node[:cassandra][:cassandra_conf] %>
CASSANDRA_USER=cassandra
CLASSPATH=$CASSANDRA_CONF:$cassandra_bin

for jar in $cassandra_home/lib/*.jar; do
  CLASSPATH=$CLASSPATH:$jar
done

ulimit -n 65535
cd var
exec chpst -u${CASSANDRA_USER} -e /etc/sv/cassandra/env -o 65535 \
  /usr/bin/java                                                   \
      -ea                                                         \
      -Xms<%= node[:cassandra][:java_min_heap] %>                 \
      -Xmx<%= node[:cassandra][:java_max_heap] %>                 \
      -Xss128k                                                    \
      -XX:+UseParNewGC                                            \
      -XX:+UseConcMarkSweepGC                                     \
      -XX:+CMSParallelRemarkEnabled                               \
      -XX:+HeapDumpOnOutOfMemoryError                             \
      -XX:SurvivorRatio=8                                         \
      -XX:MaxTenuringThreshold=1                                  \
      -XX:+AggressiveOpts                                         \
      -XX:+UseThreadPriorities                                    \
      -XX:ThreadPriorityPolicy=42                                 \
      \
      -XX:+PrintGCTimeStamps                                      \
      -XX:+PrintGCDetails                                         \
      -XX:+PrintTenuringDistribution                              \
      -Xloggc:/var/log/cassandra/cassandra-gc.log                 \
      \
      -Dcassandra.compaction.priority=1                           \
      -Djava.rmi.server.hostname=<%= node[:ec2][:public_hostname] %> \
      -Dcom.sun.management.jmxremote.port=<%= node[:cassandra][:jmx_port] %>                    \
      -Dcom.sun.management.jmxremote.ssl=false                    \
      -Dcom.sun.management.jmxremote.authenticate=false           \
      -Dcassandra -Dstorage-config=${CASSANDRA_CONF}              \
      -Dcassandra-foreground=yes                                  \
      -cp ${CLASSPATH}                                            \
      org.apache.cassandra.thrift.CassandraDaemon 2>&1

# add in for 64-bit
#      -XX:+UseCompressedOops                                      \
